<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie World Dashboard</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            font-family: 'Raleway', Arial, sans-serif;
        }
        body {
            display: flex;
            flex-direction: column;
            background-color: #fff;
            color: #111;
        }
        .header {
            padding: 10px 18px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-title {
            font-size: 18px;
            font-weight: 600;
        }
        .header-sub {
            font-size: 12px;
            color: #666;
        }
        .filters {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }
        .filters select, .filters input[type=range] {
            font-size: 13px;
        }
        .filters input[type=range] {
            width: 120px;
        }
        .main-container {
            flex: 1;
            display: flex;
            padding: 10px;
            gap: 10px;
        }
        #globe {
            flex: 2;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: rgba(192,192,192,0.25);
            position: relative;
        }
        .right-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 8px 10px;
            background-color: rgba(240,128,128,0.03);
        }
        .panel h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .panel small {
            font-size: 11px;
            color: #666;
        }
        #directorBar {
            height: 240px;
        }
        #movieScatter {
            min-height: 260px;
        }
        .tooltip {
            position: absolute;
            pointer-events: none;
            padding: 6px 10px;
            background: rgba(50,45,45,0.9);
            color: #fff;
            border-radius: 4px;
            font-size: 11px;
            opacity: 0;
        }
        .scatter-panel {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 4px 4px 2px 4px;
            margin-top: 8px;
            background-color: #fff;
        }
        .scatter-title {
            font-size: 12px;
            font-weight: 600;
            margin: 2px 4px 0 4px;
        }
    </style>
</head>
<body>

<div class="header">
    <div>
        <div class="header-title">Movie Visualization – Genre × Country × Directors</div>
        <div class="header-sub">Heatmap (Rating) · Top Directors (bar ngang) · Movies (scatter: Budget vs Gross, màu Rating)</div>
    </div>
    <div class="filters">
        <span>Year:</span>
        <span id="yearMinLabel"></span>
        <input type="range" id="yearMinSlider">
        <span>to</span>
        <span id="yearMaxLabel"></span>
        <input type="range" id="yearMaxSlider">
        <span>| Genre:</span>
        <select id="genreSelect">
            <option value="">All</option>
        </select>
    </div>
</div>

<div class="main-container">
    <div id="globe"></div>

    <div class="right-panel">
        <div class="panel">
            <h3>1️⃣ Top directors by number of movies (bar ngang)</h3>
            <small>Đếm số phim theo từng đạo diễn trong quốc gia & thể loại & khoảng năm đang chọn.</small>
            <div id="directorBar"></div>
        </div>

        <div class="panel">
            <h3>2️⃣ Top director(s) movies – Scatter (Budget vs Gross, màu = Rating)</h3>
            <small>
                Nếu có nhiều đạo diễn đồng top (số phim bằng nhau), mỗi đạo diễn sẽ có một scatter riêng.
            </small>
            <div id="movieScatter"></div>
        </div>
    </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
    // ====== Data từ backend (geojson + years) ======
    var worldData = {{ world_geojson|tojson }};
    var YEAR_MIN = {{ year_min }};
    var YEAR_MAX = {{ year_max }};

    // ====== State ======
    var currentGenre = "";
    var currentYearMin = YEAR_MIN;
    var currentYearMax = YEAR_MAX;
    var currentCountry = null;

    var summaryIndex = {};    // countryName -> {avg_rating, movie_count, director_count}
    var currentMinRating = null;
    var currentMaxRating = null;

    var tooltip = d3.select("#tooltip");

    // ====== Color cho heatmap ======
    function heatColor(t) {
        var a = d3.rgb(251,193,190); // light
        var b = d3.rgb(150,1,122);   // dark
        return d3.interpolate(a, b)(t);
    }

    function getCountryColor(name) {
        var info = summaryIndex[name];
        if (!info || currentMinRating === null || currentMaxRating === null || currentMinRating === currentMaxRating) {
            return "#e0e0e0";
        }
        var t = (info.avg_rating - currentMinRating) / (currentMaxRating - currentMinRating);
        t = Math.max(0, Math.min(1, t));
        return heatColor(t);
    }

    // ====== Init filters (genre + year sliders) ======
    function initFilters() {
        var minSlider = document.getElementById("yearMinSlider");
        var maxSlider = document.getElementById("yearMaxSlider");
        var minLabel = document.getElementById("yearMinLabel");
        var maxLabel = document.getElementById("yearMaxLabel");

        minSlider.min = YEAR_MIN;
        minSlider.max = YEAR_MAX;
        maxSlider.min = YEAR_MIN;
        maxSlider.max = YEAR_MAX;

        minSlider.value = YEAR_MIN;
        maxSlider.value = YEAR_MAX;
        minLabel.textContent = YEAR_MIN;
        maxLabel.textContent = YEAR_MAX;

        minSlider.addEventListener("input", function() {
            var v = parseInt(minSlider.value, 10);
            if (v > parseInt(maxSlider.value, 10)) {
                v = parseInt(maxSlider.value, 10);
                minSlider.value = v;
            }
            currentYearMin = v;
            minLabel.textContent = v;
            loadSummary();
        });

        maxSlider.addEventListener("input", function() {
            var v = parseInt(maxSlider.value, 10);
            if (v < parseInt(minSlider.value, 10)) {
                v = parseInt(minSlider.value, 10);
                maxSlider.value = v;
            }
            currentYearMax = v;
            maxLabel.textContent = v;
            loadSummary();
        });

        // load genre list
        fetch("/api/filters")
            .then(function(res){ return res.json(); })
            .then(function(data){
                var select = document.getElementById("genreSelect");
                data.genres.forEach(function(g){
                    var opt = document.createElement("option");
                    opt.value = g;
                    opt.textContent = g;
                    select.appendChild(opt);
                });
            });

        document.getElementById("genreSelect").addEventListener("change", function(){
            currentGenre = this.value;
            loadSummary();
        });
    }

    // ====== Vẽ map thế giới (1 lần) ======
    function drawWorldMap() {
        d3.select("#globe").selectAll("*").remove();

        var container = document.getElementById("globe");
        var width = container.clientWidth || 500;
        var height = container.clientHeight || 400;

        var svg = d3.select("#globe")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        var projection = d3.geo.mercator()
            .scale(width * 0.15)
            .translate([width / 2, height / 1.5]);

        var path = d3.geo.path().projection(projection);

        svg.selectAll("path.country")
            .data(worldData.features)
            .enter()
            .append("path")
            .attr("class", "country")
            .attr("d", path)
            .style("stroke", "#fff")
            .style("stroke-width", 0.5)
            .style("fill", function(d) {
                return getCountryColor(d.properties.name);
            })
            .on("mouseover", function(d) {
                d3.select(this).style("stroke-width", 1.5);
                var name = d.properties.name;
                var info = summaryIndex[name];
                var ratingText = "No data";
                var details = "";
                if (info) {
                    ratingText = info.avg_rating.toFixed(2);
                    details = "<br/>Movies: " + info.movie_count + "<br/>Directors: " + info.director_count;
                }
                tooltip
                    .style("opacity", 0.95)
                    .html("<strong>" + name + "</strong><br/>Avg Rating: " + ratingText + details)
                    .style("left", (d3.event.pageX + 15) + "px")
                    .style("top", (d3.event.pageY - 10) + "px");
            })
            .on("mousemove", function() {
                tooltip
                    .style("left", (d3.event.pageX + 15) + "px")
                    .style("top", (d3.event.pageY - 10) + "px");
            })
            .on("mouseout", function() {
                d3.select(this).style("stroke-width", 0.5);
                tooltip.style("opacity", 0);
            })
            .on("click", function(d) {
                var countryName = d.properties.name;
                currentCountry = countryName;
                loadCountryDetail(countryName);
            });

        // Legend
        var legendWidth = 200, legendHeight = 14;
        var legend = svg.append("g")
            .attr("class", "legend")
            .attr("transform", "translate(20, 20)");

        var gradId = "ratingGrad";
        var defs = svg.append("defs");
        var gradient = defs.append("linearGradient")
            .attr("id", gradId)
            .attr("x1", "0%").attr("x2", "100%")
            .attr("y1", "0%").attr("y2", "0%");

        gradient.append("stop").attr("offset", "0%").attr("stop-color", heatColor(0));
        gradient.append("stop").attr("offset", "100%").attr("stop-color", heatColor(1));

        legend.append("rect")
            .attr("x", 0)
            .attr("y", 10)
            .attr("width", legendWidth)
            .attr("height", legendHeight)
            .style("fill", "url(#" + gradId + ")")
            .style("stroke", "#999");

        legend.append("text")
            .attr("x", 0)
            .attr("y", 8)
            .text("Average IMDb Rating");

        legend.append("text")
            .attr("x", 0)
            .attr("y", 10 + legendHeight + 12)
            .text("Low");

        legend.append("text")
            .attr("x", legendWidth)
            .attr("y", 10 + legendHeight + 12)
            .attr("text-anchor", "end")
            .text("High");
    }

    function updateMapColors() {
        d3.select("#globe").selectAll("path.country")
            .transition().duration(600)
            .style("fill", function(d){
                return getCountryColor(d.properties.name);
            });
    }

    // ====== Load summary cho heatmap ======
    function loadSummary() {
        var params = [];
        if (currentGenre) {
            params.push("genre=" + encodeURIComponent(currentGenre));
        }
        params.push("start_year=" + encodeURIComponent(currentYearMin));
        params.push("end_year=" + encodeURIComponent(currentYearMax));

        fetch("/api/summary?" + params.join("&"))
            .then(function(res){ return res.json(); })
            .then(function(data){
                summaryIndex = {};
                data.countries.forEach(function(c){
                    summaryIndex[c.country] = c;
                });
                currentMinRating = data.min_rating;
                currentMaxRating = data.max_rating;

                updateMapColors();

                if (!currentCountry) {
                    drawDirectorBarHorizontal([], null);
                    drawMovieScatter([]);
                } else {
                    loadCountryDetail(currentCountry);
                }
            });
    }

    // ====== Load chi tiết 1 country ======
    function loadCountryDetail(countryName) {
        var params = [];
        params.push("country=" + encodeURIComponent(countryName));
        if (currentGenre) {
            params.push("genre=" + encodeURIComponent(currentGenre));
        }
        params.push("start_year=" + encodeURIComponent(currentYearMin));
        params.push("end_year=" + encodeURIComponent(currentYearMax));

        fetch("/api/country_detail?" + params.join("&"))
            .then(function(res){ return res.json(); })
            .then(function(info){
                var directors = info.directors || [];
                var topDirectors = info.top_directors || [];
                drawDirectorBarHorizontal(directors, countryName);
                drawMovieScatter(topDirectors);
            });
    }

    // ====== Bar ngang: top directors by movie_count ======
    function drawDirectorBarHorizontal(directors, countryName) {
        var container = d3.select("#directorBar");
        container.selectAll("*").remove();

        var width = document.getElementById("directorBar").clientWidth || 360;
        var height = document.getElementById("directorBar").clientHeight || 240;

        var svg = container.append("svg")
            .attr("width", width)
            .attr("height", height);

        if (!directors || directors.length === 0) {
            svg.append("text")
                .attr("x", width/2)
                .attr("y", height/2)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text(countryName ? ("No data for " + countryName) : "Click a country on the map.");
            return;
        }

        var margin = {top: 20, right: 20, bottom: 30, left: 120};
        var innerW = width - margin.left - margin.right;
        var innerH = height - margin.top - margin.bottom;

        var g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var maxCount = d3.max(directors, function(d){ return d.movie_count; }) || 1;

        var x = d3.scale.linear()
            .domain([0, maxCount * 1.1])
            .range([0, innerW]);

        var y = d3.scale.ordinal()
            .domain(directors.map(function(d){ return d.director; }))
            .rangeRoundBands([0, innerH], 0.15);

        // bars
        g.selectAll(".bar")
            .data(directors)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("y", function(d){ return y(d.director); })
            .attr("x", 0)
            .attr("height", y.rangeBand())
            .attr("width", function(d){ return x(d.movie_count); })
            .style("fill", "rgb(219,112,147)")
            .on("mouseover", function(d){
                d3.select(this).style("fill", "indianred");
                tooltip
                    .style("opacity", 0.95)
                    .html("<strong>" + d.director + "</strong><br/>Movies: " + d.movie_count)
                    .style("left", (d3.event.pageX + 15) + "px")
                    .style("top", (d3.event.pageY - 10) + "px");
            })
            .on("mouseout", function(){
                d3.select(this).style("fill", "rgb(219,112,147)");
                tooltip.style("opacity", 0);
            });

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .ticks(5)
            .tickFormat(function(d){ return d; });

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        g.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + innerH + ")")
            .call(xAxis);

        g.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .selectAll("text")
            .style("font-size", "11px");

        svg.append("text")
            .attr("x", width/2)
            .attr("y", 14)
            .attr("text-anchor", "middle")
            .style("font-size", "12px")
            .text("Top directors in " + countryName);
    }

    // ====== Scatter: movies của top director(s) (có xử lý đồng top) ======
    function drawMovieScatter(topDirectors) {
        var container = d3.select("#movieScatter");
        container.selectAll("*").remove();

        var elem = document.getElementById("movieScatter");
        var width = elem.clientWidth || 360;
        var heightPer = 260; // chiều cao cho mỗi scatter-panel (bao gồm margin)

        if (!topDirectors || topDirectors.length === 0) {
            var svg = container.append("svg")
                .attr("width", width)
                .attr("height", 80);
            svg.append("text")
                .attr("x", width/2)
                .attr("y", 40)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text("No top-director data. Click a country with movie data.");
            return;
        }

        // Gộp tất cả movies để tính chung domain scale
        var allMovies = [];
        topDirectors.forEach(function(td){
            (td.movies || []).forEach(function(m){
                allMovies.push(m);
            });
        });
        if (allMovies.length === 0) {
            var svg2 = container.append("svg")
                .attr("width", width)
                .attr("height", 80);
            svg2.append("text")
                .attr("x", width/2)
                .attr("y", 40)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text("Top-directors have no movies data.");
            return;
        }

        var maxBudget = d3.max(allMovies, function(m){ return m.budget || 0; }) || 1;
        var maxGross  = d3.max(allMovies, function(m){ return m.gross || 0; }) || 1;

        var minRating = d3.min(allMovies, function(m){ return m.rating != null ? m.rating : 10; }) || 0;
        var maxRating = d3.max(allMovies, function(m){ return m.rating != null ? m.rating : 0; }) || 10;

        // scale chung cho tất cả scatter
        var margin = {top: 28, right: 40, bottom: 60, left: 70};
        var innerW = width - margin.left - margin.right;
        var innerH = heightPer - margin.top - margin.bottom;

        var x = d3.scale.linear()
            .domain([0, maxBudget * 1.1])
            .range([0, innerW]);

        var y = d3.scale.linear()
            .domain([0, maxGross * 1.1])
            .range([innerH, 0]);

        var color = d3.scale.linear()
            .domain([minRating, maxRating])
            .range(["#9ecae1", "#08306b"]);  // từ nhạt đến đậm

        // Profit scale (gross - budget)
        var profits = allMovies.map(function(m){
            return (m.gross || 0) - (m.budget || 0);
        });

        var minProfit = d3.min(profits);
        var maxProfit = d3.max(profits);

        // tránh trường hợp tất cả = 0
        if (minProfit === maxProfit) {
            minProfit = 0;
            maxProfit = maxProfit || 1;
        }

        var sizeScale = d3.scale.linear()
            .domain([minProfit, maxProfit])
            .range([6, 26]);   // profit cao = điểm to hơn


        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .ticks(5)
            .tickFormat(function(d){ return (d/1e6).toFixed(1) + "M"; });

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .ticks(5)
            .tickFormat(function(d){ return (d/1e6).toFixed(1) + "M"; });

        topDirectors.forEach(function(td){
            var panel = container.append("div")
                .attr("class", "scatter-panel");

            panel.append("div")
                .attr("class", "scatter-title")
                .text(td.name + " (" + td.movie_count + " movies)");

            var svg = panel.append("svg")
                .attr("width", width)
                .attr("height", heightPer);

            var g = svg.append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var movies = td.movies || [];
            if (movies.length === 0) {
                g.append("text")
                    .attr("x", innerW/2)
                    .attr("y", innerH/2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "11px")
                    .text("No movie data.");
                return;
            }

            // axes
            g.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + innerH + ")")
                .call(xAxis);

            g.append("g")
                .attr("class", "y axis")
                .call(yAxis);

            // labels trục
            svg.append("text")
                .attr("x", width/2)
                .attr("y", heightPer - 10)
                .attr("text-anchor", "middle")
                .style("font-size", "11px")
                .text("Budget (Million USD)");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -heightPer/2)
                .attr("y", 16)
                .attr("text-anchor", "middle")
                .style("font-size", "11px")
                .text("Gross (Million USD)");

            // scatter points
            g.selectAll("circle")
                .data(movies)
                .enter()
                .append("circle")
                .attr("cx", function(m){ return x(m.budget || 0); })
                .attr("cy", function(m){ return y(m.gross || 0); })
                .attr("r", function(m){
                    var profit = (m.gross || 0) - (m.budget || 0);
                    return sizeScale(profit);
                })

                .style("fill", function(m){
                    return m.rating != null ? color(m.rating) : "#999";
                })
                .style("opacity", 0.9)
                .on("mouseover", function(m){
                    tooltip
                        .style("opacity", 0.95)
                        .html(
                            "<strong>" + m.title + "</strong><br/>" +
                            "Budget: " + d3.format(",.0f")(m.budget) + "<br/>" +
                            "Gross: "  + d3.format(",.0f")(m.gross) + "<br/>" +
                            "Rating: " + (m.rating != null ? m.rating : "N/A")
                        )
                        .style("left", (d3.event.pageX + 15) + "px")
                        .style("top", (d3.event.pageY - 10) + "px");
                })
                .on("mouseout", function(){
                    tooltip.style("opacity", 0);
                });
        });
    }

    // ====== INIT ======
    document.addEventListener("DOMContentLoaded", function(){
        initFilters();
        drawWorldMap();
        loadSummary();

        window.addEventListener("resize", function(){
            drawWorldMap();
            updateMapColors();
            if (currentCountry) {
                loadCountryDetail(currentCountry);
            }
        });
    });
</script>

</body>
</html>
