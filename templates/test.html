<!DOCTYPE html>
<html lang='en'>
<head>
    <title>Home | A Visualization System for Country Data</title>
    <meta charset="utf-8">
    <script src="../static/internal/d3.v3.min.js"></script>
    <script src="../static/internal/topojson.v1.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script src="../static/internal/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="../static/internal/bootstrap.min.css">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
            font-family: 'Raleway', sans-serif;
            background-color: #fff;
            color: #000;
            font-size: medium;
            font-weight: 400;
            margin: 0;
        }

        .Filter {
            width: 100%;
            height: 8%;
            float: left;
            box-sizing: border-box;
            border: 1px solid lightgrey;
            background-color: white;
        }

        .matric {
            width: 30%;
            height: 100%;
            float: left;
            box-sizing: border-box;
            border: 1px solid lightgrey;
            border-radius: 10px;
            background-color: rgba(176, 196, 222, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .yeardrag {
            width: 40%;
            height: 100%;
            float: left;
            box-sizing: border-box;
            border: 1px solid lightgrey;
            border-radius: 10px;
            background-color: rgba(176, 196, 222, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .countryselect {
            width: 30%;
            height: 100%;
            float: left;
            box-sizing: border-box;
            border: 1px solid lightgrey;
            border-radius: 10px;
            background-color: rgba(176, 196, 222, 0.2);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rectmap {
            width: 40%;
            height: 92%;
            float: left;
            box-sizing: border-box;
            border: 1px solid lightgrey;
            border-radius: 10px;
        }

        .radarChart {
            width: 100%;
            height: 60%;
            float: left;
            box-sizing: border-box;
            border: 1px solid lightgrey;
            background-color: rgba(240, 128, 128, 0.1);
            border-radius: 10px;
        }

        #rect {
            width: 100%;
            height: 40%;
            float: left;
            box-sizing: border-box;
            border: 1px solid lightgrey;
            background-color: rgba(240, 128, 128, 0.1);
            border-radius: 10px;
        }

        #globe {
            width: 47%;
            height: 92%;
            float: left;
            box-sizing: border-box;
            border: 1px solid lightgrey;
            background-color: rgba(192, 192, 192, 0.3);
            border-radius: 10px;
        }

        .matricsform {
            width: 13%;
            height: 92%;
            float: left;
            font-size: 14px;
            line-height: 2.5;
            box-sizing: border-box;
            border: 1px solid lightgrey;
            background-color: rgba(240, 128, 128, 0.2);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #matric {
            margin-top: 2%;
            margin-left: 8%;
            width: 80%;
        }

        #countries {
            margin-top: 2%;
            margin-left: 8%;
            width: 80%;
        }

        #countries option {
            background: indianred !important;
        }

        .tooltip {
            display: flex;
            flex-direction: column;
            position: absolute; /*不可缺少*/
            line-height: 1;
            font-weight: bold;
            padding: 12px;
            background-color: #322d2d;
            color: white;
            border-radius: 2px;
            text-align: center;
            opacity: 0;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .bar {
            fill: rgb(219, 112, 147);
        }

        .bar:hover {
            fill: indianred;
        }

        .x.axis path {
            display: none;
        }

        .legend {
            font-family: 'Raleway', sans-serif;
            fill: #333333;
        }

        .tt {
            display: flex;
            flex-direction: column;
            position: absolute; /*不可缺少*/
            line-height: 1;
            font-weight: bold;
            padding: 12px;
            background-color: #322d2d;
            color: white;
            border-radius: 2px;
            text-align: center;
            opacity: 0;
            letter-spacing: 2px
        }

        select, h4 {
            display: inline;
        }

        select {
            margin-left: 10px;
        }

    </style>
</head>

<body>
<div class="Filter">
    <div class="matric">
        <select id="matric" name="matric" class="selectpicker show-tick form-control"
                data-width=400 data-live-search="false">
            <option value=0>GDP growth (annual %)</option>
            <option value=1>GDP (current US$)</option>
            <option value=2>Internet users (per 100 people)</option>
            <option value=3>Rural population</option>
            <option value=4>Population- female (% of total)</option>
            <option value=5>Population growth (annual %)</option>
            <option value=6>Population- total</option>
            <option value=7>GDP per capita growth (annual %)</option>
            <option value=8>GDP per capita (current US$)</option>
            <option value=9>Labor force- total</option>
            <option value=10>Labor force- female (% of total labor force)</option>
            <option value=11>Armed forces personnel (% of total labor force)</option>
            <option value=12>Surface area (sq. km)</option>
            <option value=13>Population density (people per sq. km of land area)</option>
            <option value=14>Arable land (% of land area)</option>
            <option value=15>Unemployment- total (% of total labor force) (modeled ILO estimate)</option>
            <option value=16>Unemployment- female (% of female labor force) (modeled ILO estimate)</option>
        </select>
    </div>
    <div class="yeardrag">
        <h4>2010</h4>
        <input type="range" min="4" max="8" step="1" value="4" id="limit"
               style="width:50%"/>
        <h4>2014</h4>

    </div>
    <div class="countryselect" id="countryselect">
        <select id="countries" name="countries" class="selectpicker show-tick form-control"
                title="Select Country Code for Radar Chart Display"
                data-width=400 multiple data-max-options="6" data-selected-text-format="count" data-live-search="true">
            {% for code in CountryCode %}
                <option value={{ code }} id={{ code }}>{{ code }}</option>
            {% endfor %}
        </select>
    </div>
</div>


<div id="globe"></div>


<div class="rectmap">
    <div class="radarChart"></div>
    <div id="rect"></div>
</div>
<div class="matricsform">
    <form name="MatricForm" id="MatricForm">
        <input type="checkbox" class="checkclass" name="single" id="type1" style="margin-bottom:0px"/> GDP
        growth
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type2" style="margin-bottom:0px"/> GDP
        (current US$)
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type3" style="margin-bottom:0px"/> Internet
        users
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type4" checked style="margin-bottom:0px"/> Rural
        population
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type5" checked style="margin-bottom:0px"/>
        Population-
        female
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type1" checked style="margin-bottom:0px"/>
        Population
        growth
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type2" style="margin-bottom:0px"/> Population-
        total
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type3" style="margin-bottom:0px"/> GDP
        per
        capita growth
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type4" style="margin-bottom:0px"/> GDP
        per capita
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type5" style="margin-bottom:0px"/> Labor
        force- total
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type1" style="margin-bottom:0px"/> Labor
        force- female
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type2" style="margin-bottom:0px"/> Armed
        forces personnel
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type3" style="margin-bottom:0px"/> Surface
        area
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type4" style="margin-bottom:0px"/> Population
        density
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type5" style="margin-bottom:0px"/> Arable
        land
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type4" style="margin-bottom:0px"/> Unemployment-
        total
        </br>
        <input type="checkbox" class="checkclass" name="single" id="type5" style="margin-bottom:0px"/> Unemployment-
        female
        </br>
    </form>
</div>

</body>

<script>
    var data = {{ geojson|tojson }};
    var min_rating = {{ min_rating }};
    var max_rating = {{ max_rating }};
    var countries_with_data = {{ countries|tojson }};

    // Color như cũ
    var a = d3.rgb(251, 193, 190);
    var b = d3.rgb(150, 1, 122);
    var color = d3.interpolate(a, b);

    // Tooltip
    var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0)
        .style("position", "absolute")
        .style("background", "rgba(50,45,45,0.9)")
        .style("color", "white")
        .style("padding", "12px")
        .style("border-radius", "6px")
        .style("pointer-events", "none")
        .style("font-family", "Raleway");

    function GlobeMap() {
        d3.select("#globe svg").remove(); // xóa cũ

        var width = document.getElementById("globe").clientWidth;
        var height = document.getElementById("globe").clientHeight;

        var svg = d3.select("#globe").append("svg")
            .attr("width", "100%")
            .attr("height", "100%");

        var projection = d3.geo.mercator()
            .scale(width * 0.15)
            .translate([width / 2, height / 1.5]);

        var path = d3.geo.path().projection(projection);

        var countries = svg.selectAll("path.country")
            .data(data.features)
            .enter()
            .append("path")
            .attr("class", "country")
            .attr("d", path)
            .style("stroke", "#fff")
            .style("stroke-width", 0.5)
            .style("fill", function(d) {
                var r = d.properties.avgIMDbRating;
                if (r === null) return "#e0e0e0";
                var t = (r - min_rating) / (max_rating - min_rating);
                return color(t);
            })
            .on("mouseover", function(d) {
                d3.select(this).style("fill", "#ff69b4");
                var rating = d.properties.avgIMDbRating;
                var text = rating ? rating.toFixed(2) : "No movies";
                tooltip.html("<strong>" + d.properties.name + "</strong><br>Avg IMDb Rating: <strong>" + text + "</strong>")
                    .style("left", (d3.event.pageX + 15) + "px")
                    .style("top", (d3.event.pageY - 10) + "px")
                    .transition().duration(200).style("opacity", 0.95);
            })
            .on("mouseout", function(d) {
                d3.select(this).style("fill", function(d) {
                    var r = d.properties.avgIMDbRating;
                    if (r === null) return "#e0e0e0";
                    var t = (r - min_rating) / (max_rating - min_rating);
                    return color(t);
                });
                tooltip.transition().duration(500).style("opacity", 0);
            })
            .on("click", function(d) {
                if (!d.properties.avgIMDbRating) {
                    alert("No movie data for " + d.properties.name);
                    return;
                }
                // Tự động chọn vào dropdown nếu có
                var select = document.getElementById("countries");
                for (var i = 0; i < select.options.length; i++) {
                    if (select.options[i].text === d.properties.name || 
                        select.options[i].value === d.id) {
                        select.options[i].selected = true;
                        break;
                    }
                }
                CountrySel = $("#countries").val() || [];
                updateR();
                updateRadarChart(radarChartOptions);
            });

        // Legend
        var legend = svg.append("g").attr("transform", "translate(30,30)");
        var gradient = svg.append("defs").append("linearGradient")
            .attr("id", "grad")
            .attr("x1", "0%").attr("x2", "100%");
        gradient.append("stop").attr("offset", "0%").attr("stop-color", color(0));
        gradient.append("stop").attr("offset", "100%").attr("stop-color", color(1));

        legend.append("rect")
            .attr("width", 220).attr("height", 20)
            .style("fill", "url(#grad)")
            .style("stroke", "#999");

        legend.append("text").attr("x", 0).attr("y", -5).text(min_rating.toFixed(1));
        legend.append("text").attr("x", 220).attr("y", -5).attr("text-anchor", "end").text(max_rating.toFixed(1));
        legend.append("text").attr("x", 110).attr("y", -10).attr("text-anchor", "middle")
            .text("Average IMDb Rating").style("font-weight", "bold");
    }

    // Gọi lần đầu
    GlobeMap();

    // Responsive
    window.addEventListener("resize", function() {
        setTimeout(GlobeMap, 100);
    });

    // Không cần updateM() nữa vì không đổi metric/năm
    function updateM() { GlobeMap(); }
</script>

</html>