<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie World Dashboard | Genre, Country & Directors</title>
    <!-- D3 v3 -->
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            font-family: 'Raleway', Arial, sans-serif;
            background-color: #ffffff;
            color: #111;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        .header {
            width: 100%;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
        }
        .year-filters {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .year-filters label {
            font-size: 14px;
        }
        .year-filters input[type=range] {
            width: 140px;
        }
        .main-container {
            flex: 1;
            display: flex;
            padding: 10px;
            gap: 10px;
        }
        #globe {
            flex: 2;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: rgba(192, 192, 192, 0.3);
            position: relative;
        }
        .right-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            background-color: rgba(240, 128, 128, 0.05);
        }
        .panel h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .panel small {
            font-size: 11px;
            color: #666;
        }
        #genrePanel {
            max-height: 150px;
        }
        #genreSelect {
            width: 100%;
            margin-top: 5px;
            padding: 4px;
        }
        #directorBar, #movieBar {
            height: 220px;
        }
        .tooltip {
            position: absolute;
            pointer-events: none;
            padding: 8px 10px;
            background: rgba(50, 45, 45, 0.9);
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        .legend text {
            font-size: 11px;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="header-title">
        Movie Visualization – Genre × Country × Directors
    </div>
    <div class="year-filters">
        <label>Year from <span id="yearMinLabel"></span></label>
        <input type="range" id="yearMinSlider">
        <label>to <span id="yearMaxLabel"></span></label>
        <input type="range" id="yearMaxSlider">
    </div>
</div>

<div class="main-container">
    <div id="globe"></div>

    <div class="right-panel">
        <div class="panel" id="genrePanel">
            <h3>1️⃣ Main Genre Filter</h3>
            <small>Chọn thể loại chính. Tất cả biểu đồ sẽ lọc theo thể loại & khoảng năm.</small>
            <select id="genreSelect">
                <option value="">All genres</option>
            </select>
        </div>

        <div class="panel">
            <h3>2️⃣ Versatile Bar Chart – Directors (selected country)</h3>
            <small>Số phim thuộc thể loại & khoảng năm đã chọn, cho từng đạo diễn của quốc gia đang click.</small>
            <div id="directorBar"></div>
        </div>

        <div class="panel">
            <h3>3️⃣ Top Director – Movies (Budget vs Total Gross)</h3>
            <small>1–5 phim của đạo diễn có số phim cao nhất trong quốc gia & thể loại & khoảng năm đã chọn.</small>
            <div id="movieBar"></div>
        </div>
    </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
    // ======= Data from backend (GeoJSON + year bounds) =======
    var worldData = {{ world_geojson|tojson }};
    var YEAR_MIN = {{ year_min }};
    var YEAR_MAX = {{ year_max }};

    // ======= State =======
    var currentGenre = "";
    var currentYearMin = YEAR_MIN;
    var currentYearMax = YEAR_MAX;
    var summaryIndex = {};  // countryName -> summary
    var currentCountry = null;
    var currentMinRating = null;
    var currentMaxRating = null;

    var tooltip = d3.select("#tooltip");

    // ======= Color for heatmap =======
    function getColorScale(t) {
        var a = d3.rgb(251, 193, 190);  // light
        var b = d3.rgb(150, 1, 122);    // dark
        return d3.interpolate(a, b)(t);
    }

    // ======= Initialize genre & year filters via API =======
    function initFilters() {
        // Initialize year sliders
        var minSlider = document.getElementById("yearMinSlider");
        var maxSlider = document.getElementById("yearMaxSlider");
        var minLabel = document.getElementById("yearMinLabel");
        var maxLabel = document.getElementById("yearMaxLabel");

        minSlider.min = YEAR_MIN;
        minSlider.max = YEAR_MAX;
        maxSlider.min = YEAR_MIN;
        maxSlider.max = YEAR_MAX;

        minSlider.value = YEAR_MIN;
        maxSlider.value = YEAR_MAX;
        minLabel.textContent = YEAR_MIN;
        maxLabel.textContent = YEAR_MAX;

        minSlider.addEventListener("input", function() {
            var v = parseInt(minSlider.value, 10);
            if (v > parseInt(maxSlider.value, 10)) {
                v = parseInt(maxSlider.value, 10);
                minSlider.value = v;
            }
            currentYearMin = v;
            minLabel.textContent = v;
            loadSummary();
        });

        maxSlider.addEventListener("input", function() {
            var v = parseInt(maxSlider.value, 10);
            if (v < parseInt(minSlider.value, 10)) {
                v = parseInt(minSlider.value, 10);
                maxSlider.value = v;
            }
            currentYearMax = v;
            maxLabel.textContent = v;
            loadSummary();
        });

        // Fetch genres
        fetch("/api/filters")
            .then(function(res) { return res.json(); })
            .then(function(data) {
                var select = document.getElementById("genreSelect");
                data.genres.forEach(function(g) {
                    var opt = document.createElement("option");
                    opt.value = g;
                    opt.textContent = g;
                    select.appendChild(opt);
                });
            });

        document.getElementById("genreSelect").addEventListener("change", function() {
            currentGenre = this.value;
            loadSummary();
        });
    }

    // ======= Draw world map (once) =======
    function drawWorldMap() {
        d3.select("#globe").selectAll("*").remove();

        var container = document.getElementById("globe");
        var width = container.clientWidth;
        var height = container.clientHeight || 500;

        var svg = d3.select("#globe")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        var projection = d3.geo.mercator()
            .scale(width * 0.15)
            .translate([width / 2, height / 1.5]);

        var path = d3.geo.path().projection(projection);

        var countries = svg.selectAll("path.country")
            .data(worldData.features)
            .enter()
            .append("path")
            .attr("class", "country")
            .attr("d", path)
            .style("stroke", "#fff")
            .style("stroke-width", 0.5)
            .style("fill", function(d) {
                return getCountryColor(d.properties.name);
            })
            .on("mouseover", function(d) {
                d3.select(this).style("stroke-width", 1.5);
                var name = d.properties.name;
                var info = summaryIndex[name];
                var ratingText = "No data";
                var details = "";
                if (info) {
                    ratingText = info.avg_rating.toFixed(2);
                    details = "<br/>Movies: " + info.movie_count + "<br/>Directors: " + info.director_count;
                }
                tooltip
                    .style("opacity", 0.95)
                    .html("<strong>" + name + "</strong><br/>Avg Rating: " + ratingText + details)
                    .style("left", (d3.event.pageX + 15) + "px")
                    .style("top", (d3.event.pageY - 10) + "px");
            })
            .on("mousemove", function() {
                tooltip
                    .style("left", (d3.event.pageX + 15) + "px")
                    .style("top", (d3.event.pageY - 10) + "px");
            })
            .on("mouseout", function() {
                d3.select(this).style("stroke-width", 0.5);
                tooltip.style("opacity", 0);
            })
            .on("click", function(d) {
                var countryName = d.properties.name;
                currentCountry = countryName;
                loadCountryDetail(countryName);
            });

        // Legend
        var legendWidth = 200, legendHeight = 14;
        var legend = svg.append("g")
            .attr("class", "legend")
            .attr("transform", "translate(20, 20)");

        var gradId = "ratingGrad";
        var defs = svg.append("defs");
        var gradient = defs.append("linearGradient")
            .attr("id", gradId)
            .attr("x1", "0%").attr("x2", "100%")
            .attr("y1", "0%").attr("y2", "0%");

        gradient.append("stop").attr("offset", "0%").attr("stop-color", getColorScale(0));
        gradient.append("stop").attr("offset", "100%").attr("stop-color", getColorScale(1));

        legend.append("rect")
            .attr("x", 0)
            .attr("y", 10)
            .attr("width", legendWidth)
            .attr("height", legendHeight)
            .style("fill", "url(#" + gradId + ")")
            .style("stroke", "#999");

        legend.append("text")
            .attr("x", 0)
            .attr("y", 8)
            .text("Average IMDb Rating");

        legend.append("text")
            .attr("x", 0)
            .attr("y", 10 + legendHeight + 12)
            .text("Low");

        legend.append("text")
            .attr("x", legendWidth)
            .attr("y", 10 + legendHeight + 12)
            .attr("text-anchor", "end")
            .text("High");
    }

    function getCountryColor(countryName) {
        var info = summaryIndex[countryName];
        if (!info || currentMinRating === null || currentMaxRating === null || currentMinRating === currentMaxRating) {
            return "#e0e0e0";
        }
        var t = (info.avg_rating - currentMinRating) / (currentMaxRating - currentMinRating);
        t = Math.max(0, Math.min(1, t));
        return getColorScale(t);
    }

    // ======= Reload colors when summary changes =======
    function updateMapColors() {
        d3.select("#globe").selectAll("path.country")
            .transition()
            .duration(600)
            .style("fill", function(d) {
                return getCountryColor(d.properties.name);
            });
    }

    // ======= Load summary for heatmap =======
    function loadSummary() {
        var params = [];
        if (currentGenre) {
            params.push("genre=" + encodeURIComponent(currentGenre));
        }
        params.push("start_year=" + encodeURIComponent(currentYearMin));
        params.push("end_year=" + encodeURIComponent(currentYearMax));

        fetch("/api/summary?" + params.join("&"))
            .then(function(res) { return res.json(); })
            .then(function(data) {
                summaryIndex = {};
                data.countries.forEach(function(c) {
                    summaryIndex[c.country] = c;
                });
                currentMinRating = data.min_rating;
                currentMaxRating = data.max_rating;
                updateMapColors();
                // Khi đổi filter mà chưa click country, clear charts
                if (!currentCountry) {
                    drawDirectorBar([]);
                    drawMovieBar(null, []);
                } else {
                    // reload detail cho country đang chọn
                    loadCountryDetail(currentCountry);
                }
            });
    }

    // ======= Load detail for one country =======
    function loadCountryDetail(countryName) {
        var params = [];
        params.push("country=" + encodeURIComponent(countryName));
        if (currentGenre) {
            params.push("genre=" + encodeURIComponent(currentGenre));
        }
        params.push("start_year=" + encodeURIComponent(currentYearMin));
        params.push("end_year=" + encodeURIComponent(currentYearMax));

        fetch("/api/country_detail?" + params.join("&"))
            .then(function(res) { return res.json(); })
            .then(function(info) {
                var directors = info.directors || [];
                var topDirector = info.top_director || null;
                drawDirectorBar(directors, countryName);
                if (topDirector) {
                    drawMovieBar(topDirector.name, topDirector.movies || []);
                } else {
                    drawMovieBar(null, []);
                }
            });
    }

    // ======= Bar chart 1: versatile directors =======
    function drawDirectorBar(directors, countryName) {
        var container = d3.select("#directorBar");
        container.selectAll("*").remove();

        var width = document.getElementById("directorBar").clientWidth || 350;
        var height = document.getElementById("directorBar").clientHeight || 220;

        var svg = container.append("svg")
            .attr("width", width)
            .attr("height", height);

        if (!directors || directors.length === 0) {
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "13px")
                .text(countryName ? ("No data for " + countryName) : "No country selected");
            return;
        }

        var margin = {top: 20, right: 30, bottom: 70, left: 50};
        var innerW = width - margin.left - margin.right;
        var innerH = height - margin.top - margin.bottom;

        var g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var x = d3.scale.ordinal()
            .domain(directors.map(function(d) { return d.director; }))
            .rangeRoundBands([0, innerW], 0.2);

        var y = d3.scale.linear()
            .domain([0, d3.max(directors, function(d) { return d.movie_count; }) || 1])
            .range([innerH, 0]);

        g.selectAll(".bar")
            .data(directors)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", function(d) { return x(d.director); })
            .attr("y", function(d) { return y(d.movie_count); })
            .attr("width", x.rangeBand())
            .attr("height", function(d) { return innerH - y(d.movie_count); })
            .attr("fill", "rgb(219,112,147)")
            .on("mouseover", function(d) {
                d3.select(this).attr("fill", "indianred");
                tooltip
                    .style("opacity", 0.95)
                    .html("<strong>" + d.director + "</strong><br/>Movies: " + d.movie_count)
                    .style("left", (d3.event.pageX + 15) + "px")
                    .style("top", (d3.event.pageY - 10) + "px");
            })
            .on("mouseout", function() {
                d3.select(this).attr("fill", "rgb(219,112,147)");
                tooltip.style("opacity", 0);
            });

        g.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + innerH + ")")
            .call(d3.svg.axis().scale(x).orient("bottom"))
            .selectAll("text")
            .style("font-size", "10px")
            .style("text-anchor", "end")
            .attr("dx", "-0.5em")
            .attr("dy", "0.15em")
            .attr("transform", "rotate(-35)");

        g.append("g")
            .attr("class", "y axis")
            .call(d3.svg.axis().scale(y).orient("left").ticks(5));

        if (countryName) {
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 14)
                .attr("text-anchor", "middle")
                .style("font-size", "13px")
                .text("Directors in " + countryName);
        }
    }

    // ======= Bar chart 2: grouped bars for movies =======
    function drawMovieBar(directorName, movies) {
        var container = d3.select("#movieBar");
        container.selectAll("*").remove();

        var width = document.getElementById("movieBar").clientWidth || 350;
        var height = document.getElementById("movieBar").clientHeight || 220;

        var svg = container.append("svg")
            .attr("width", width)
            .attr("height", height);

        if (!directorName || !movies || movies.length === 0) {
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "13px")
                .text("No top-director data");
            return;
        }

        var margin = {top: 24, right: 20, bottom: 70, left: 60};
        var innerW = width - margin.left - margin.right;
        var innerH = height - margin.top - margin.bottom;

        var g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var x0 = d3.scale.ordinal()
            .domain(movies.map(function(d) { return d.title; }))
            .rangeRoundBands([0, innerW], 0.2);

        var x1 = d3.scale.ordinal()
            .domain(["total_gross", "total_budget"])
            .rangeRoundBands([0, x0.rangeBand()], 0.1);

        var y = d3.scale.linear()
            .domain([0, d3.max(movies, function(d) {
                return Math.max(d.total_gross || 0, d.total_budget || 0);
            }) || 1])
            .range([innerH, 0]);

        var color = d3.scale.ordinal()
            .domain(["total_gross", "total_budget"])
            .range(["#ff6666", "#6699ff"]);

        // grouped bars
        var movieGroups = g.selectAll(".movieGroup")
            .data(movies)
            .enter()
            .append("g")
            .attr("class", "movieGroup")
            .attr("transform", function(d) { return "translate(" + x0(d.title) + ",0)"; });

        movieGroups.selectAll("rect")
            .data(function(d) {
                return [
                    {key: "total_gross", value: d.total_gross || 0},
                    {key: "total_budget", value: d.total_budget || 0}
                ];
            })
            .enter()
            .append("rect")
            .attr("x", function(d) { return x1(d.key); })
            .attr("y", function(d) { return y(d.value); })
            .attr("width", x1.rangeBand())
            .attr("height", function(d) { return innerH - y(d.value); })
            .style("fill", function(d) { return color(d.key); })
            .on("mouseover", function(d) {
                var label = d.key === "total_gross" ? "Total Gross" : "Total Budget";
                tooltip
                    .style("opacity", 0.95)
                    .html(label + ": " + d.value.toLocaleString())
                    .style("left", (d3.event.pageX + 15) + "px")
                    .style("top", (d3.event.pageY - 10) + "px");
            })
            .on("mouseout", function() {
                tooltip.style("opacity", 0);
            });

        // axes
        g.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + innerH + ")")
            .call(d3.svg.axis().scale(x0).orient("bottom"))
            .selectAll("text")
            .style("font-size", "10px")
            .style("text-anchor", "end")
            .attr("dx", "-0.5em")
            .attr("dy", "0.15em")
            .attr("transform", "rotate(-35)");

        g.append("g")
            .attr("class", "y axis")
            .call(d3.svg.axis().scale(y).orient("left").ticks(5));

        // legend
        var legend = g.append("g")
            .attr("class", "legend")
            .attr("transform", "translate(" + (innerW - 120) + ",0)");

        var items = ["Total Gross", "Total Budget"];
        items.forEach(function(label, i) {
            var key = i === 0 ? "total_gross" : "total_budget";
            var row = legend.append("g").attr("transform", "translate(0," + (i * 16) + ")");
            row.append("rect")
                .attr("width", 10)
                .attr("height", 10)
                .style("fill", color(key));
            row.append("text")
                .attr("x", 14)
                .attr("y", 9)
                .text(label)
                .style("font-size", "11px");
        });

        // title
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", 16)
            .attr("text-anchor", "middle")
            .style("font-size", "13px")
            .style("font-weight", "600")
            .text("Top director: " + directorName);
    }

    // ======= Init =======
    document.addEventListener("DOMContentLoaded", function() {
        initFilters();
        drawWorldMap();
        loadSummary();
        window.addEventListener("resize", function() {
            drawWorldMap();
            updateMapColors();
            if (currentCountry) {
                loadCountryDetail(currentCountry);
            }
        });
    });
</script>
</body>
</html>
